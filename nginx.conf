# Nginx 리버스 프록시 설정
# 파일 위치: /etc/nginx/sites-available/devictoria
# 심볼릭 링크: sudo ln -s /etc/nginx/sites-available/devictoria /etc/nginx/sites-enabled/
# 테스트: sudo nginx -t
# 재시작: sudo systemctl restart nginx

# API Gateway
upstream api_backend {
    server localhost:8080;
}

# Chat Service
upstream chat_backend {
    server localhost:9002;
}

# Vision Service
upstream vision_backend {
    server localhost:9001;
}

# api.devictoria.shop
server {
    listen 80;
    server_name api.devictoria.shop;

    client_max_body_size 50M;

    location / {
        proxy_pass http://api_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # CORS 헤더 (필요시)
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }

    location /actuator/health {
        proxy_pass http://api_backend/actuator/health;
        access_log off;
    }

    # SSL 설정은 Let's Encrypt 설정 후 자동 추가됨
}

# chat.devictoria.shop
server {
    listen 80;
    server_name chat.devictoria.shop;

    location / {
        proxy_pass http://chat_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 지원 (필요시)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /health {
        proxy_pass http://chat_backend/health;
        access_log off;
    }
}

# vision.devictoria.shop
server {
    listen 80;
    server_name vision.devictoria.shop;

    client_max_body_size 100M;

    location / {
        proxy_pass http://vision_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 타임아웃 설정 (Vision AI 처리 시간 고려)
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    location /health {
        proxy_pass http://vision_backend/health;
        access_log off;
    }
}

# 기본 서버 (요청이 잘못된 경우)
server {
    listen 80 default_server;
    server_name _;
    return 444;
}

