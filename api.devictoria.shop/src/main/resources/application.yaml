spring:
  application:
    name: api
  main:
    web-application-type: reactive  # Spring Cloud Gateway는 WebFlux 기반
  cloud:
    config:
      enabled: false
    gateway:
      routes:
        # OAuth Service 라우팅 - /api/auth 경로는 oauthservice로
        - id: oauth-service
          uri: http://oauth-service:8080
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=2  # /api/auth 제거하고 전달
        
        # 카카오 OAuth 콜백 라우팅 - /oauth2/kakao/callback 경로는 oauthservice로
        - id: kakao-oauth-callback
          uri: http://oauth-service:8080
          predicates:
            - Path=/oauth2/kakao/callback/**
          filters:
            - RewritePath=/oauth2/kakao/callback, /kakao/callback
        
        # 구글 OAuth 콜백 라우팅 - /oauth2/google/callback 경로는 oauthservice로
        - id: google-oauth-callback
          uri: http://oauth-service:8080
          predicates:
            - Path=/oauth2/google/callback/**
          filters:
            - RewritePath=/oauth2/google/callback, /google/callback
        
        # 네이버 OAuth 콜백 라우팅 - /oauth2/naver/callback 경로는 oauthservice로
        - id: naver-oauth-callback
          uri: http://oauth-service:8080
          predicates:
            - Path=/oauth2/naver/callback/**
          filters:
            - RewritePath=/oauth2/naver/callback, /naver/callback
        
        # User Service 라우팅
        - id: user-service
          uri: http://userservice:8082
          predicates:
            - Path=/api/user/**
      
        # ML Service (Titanic Service) 라우팅 - /api/titanic 경로는 mlservice로
        - id: titanic-service
          uri: http://mlservice:9006
          predicates:
            - Path=/api/titanic/**
          # StripPrefix 제거 - router의 prefix(/api/titanic)와 일치하도록 전체 경로 전달
        
        # Transformer Service 라우팅은 /transformer-docs로 변경 (Gateway Swagger가 /docs 사용)
        - id: transformer-swagger
          uri: http://transformer:9007
          predicates:
            - Path=/transformer-docs/**
          filters:
            - StripPrefix=0
        
        # ML Service 라우팅 - /api/ml 경로는 mlservice로
        - id: ml-service
          uri: http://mlservice:9006
          predicates:
            - Path=/api/ml/**
          filters:
            - StripPrefix=2  # /api/ml 제거하고 전달
        
        # ML Service Swagger UI 라우팅 (transformer가 우선이므로 이건 사용되지 않음)
        - id: ml-service-swagger
          uri: http://mlservice:9006
          predicates:
            - Path=/ml-docs/**
          filters:
            - StripPrefix=0
        
        # Transformer Service ReDoc 라우팅 (우선순위)
        - id: transformer-redoc
          uri: http://transformer:9007
          predicates:
            - Path=/redoc/**
          filters:
            - StripPrefix=0
        
        # Transformer Service OpenAPI JSON 라우팅 (우선순위)
        - id: transformer-openapi
          uri: http://transformer:9007
          predicates:
            - Path=/openapi.json
          filters:
            - StripPrefix=0
        
        # ML Service ReDoc 라우팅 (transformer가 우선이므로 사용되지 않음)
        - id: ml-service-redoc
          uri: http://mlservice:9006
          predicates:
            - Path=/ml-redoc/**
          filters:
            - StripPrefix=0
        
        # ML Service OpenAPI (transformer가 우선이므로 사용되지 않음)
        - id: ml-openapi
          uri: http://mlservice:9006
          predicates:
            - Path=/ml-openapi.json
          filters:
            - StripPrefix=0
        
        # ML Service direct path for Swagger try-out (when it calls /nlp/... without /api/ml prefix)
        - id: ml-service-direct
          uri: http://mlservice:9006
          predicates:
            - Path=/nlp/**
          filters:
            - StripPrefix=0
        
        # ML Service direct path for Swagger try-out (when it calls /us_map/... without /api/ml prefix)
        - id: ml-service-us-map-direct
          uri: http://mlservice:9006
          predicates:
            - Path=/us_map/**
          filters:
            - StripPrefix=0
        
        # ML Service direct path for Swagger try-out (when it calls /seoul_map/... without /api/ml prefix)
        - id: ml-service-seoul-map-direct
          uri: http://mlservice:9006
          predicates:
            - Path=/seoul_map/**
          filters:
            - StripPrefix=0
        
        # ML Service Samsung 라우팅
        - id: ml-service-samsung
          uri: http://mlservice:9006
          predicates:
            - Path=/samsung/**
          filters:
            - StripPrefix=0
        
        # Transformer Service 라우팅 - /api/sentiment 경로는 transformer로
        - id: transformer-service
          uri: http://transformer:9007
          predicates:
            - Path=/api/sentiment/**
          filters:
            - StripPrefix=2  # /api/sentiment 제거하고 전달
        
        # Transformer Service root 및 ping 라우팅
        - id: transformer-root
          uri: http://transformer:9007
          predicates:
            - Path=/ping
          filters:
            - StripPrefix=0
      
      # 글로벌 CORS 설정은 CorsWebFilterConfig에서 처리

  # DataSource 설정 (Neon DB 연결)
  # .env 파일의 SPRING_DATASOURCE_* 환경 변수 사용
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/devictoria}
    driver-class-name: org.postgresql.Driver
    username: ${SPRING_DATASOURCE_USERNAME:postgres}
    password: ${SPRING_DATASOURCE_PASSWORD:}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 1  # 초기 연결 속도 개선
      connection-timeout: 10000  # 타임아웃을 10초로 단축 (빠른 실패)
      idle-timeout: 600000
      max-lifetime: 1800000
      initialization-fail-timeout: 10000  # 초기화 실패 타임아웃
  
  jpa:
    hibernate:
      ddl-auto: update  # 개발: update, 운영: validate 또는 none
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          lob:
            non_contextual_creation: true
  
  # Redis 설정 (Upstash Redis - .env 파일의 환경 변수 사용)
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      username: ${REDIS_USERNAME:}
      ssl:
        enabled: ${REDIS_SSL_ENABLED:true}  # Upstash Redis는 SSL 필요 (기본값: true)
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

server:
  port: 8080

# Springdoc OpenAPI (Swagger) 설정
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /docs  # Swagger UI 경로를 /docs로 변경
    enabled: true
    urls:
      - name: API Gateway
        url: /v3/api-docs
  show-actuator: false
